# 05 - è®°å¿†ç³»ç»Ÿè¯¦è§£

è®°å¿†ç³»ç»Ÿæ˜¯NPCæ™ºèƒ½ä½“çš„"å¤§è„‘"ï¼Œè®©NPCèƒ½å¤Ÿè®°ä½è¿‡å»çš„å¯¹è¯ã€å­¦ä¹ æ–°çŸ¥è¯†ã€ç†è§£ç¯å¢ƒã€‚

## ğŸ§  ä»€ä¹ˆæ˜¯è®°å¿†ç³»ç»Ÿï¼Ÿ

æƒ³è±¡ä¸€ä¸‹äººç±»çš„è®°å¿†ï¼š
- ä½ è®°å¾—åˆšæ‰è¯´çš„è¯ï¼ˆ**å·¥ä½œè®°å¿†**ï¼‰
- ä½ è®°å¾—æ˜¨å¤©å‘ç”Ÿçš„äº‹ï¼ˆ**æƒ…æ™¯è®°å¿†**ï¼‰
- ä½ è®°å¾—å­¦è¿‡çš„çŸ¥è¯†ï¼ˆ**è¯­ä¹‰è®°å¿†**ï¼‰
- ä½ æ„ŸçŸ¥åˆ°å‘¨å›´çš„ç¯å¢ƒï¼ˆ**æ„ŸçŸ¥è®°å¿†**ï¼‰

NPCçš„è®°å¿†ç³»ç»Ÿä¹Ÿæ˜¯è¿™æ ·è®¾è®¡çš„ï¼

---

## ğŸ“Š å››å±‚è®°å¿†æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NPCè®°å¿†ç³»ç»Ÿ                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚  å·¥ä½œè®°å¿†     â”‚  â”‚  æ„ŸçŸ¥è®°å¿†     â”‚  â† çŸ­æœŸã€ä¸´æ—¶     â”‚
â”‚  â”‚ Working      â”‚  â”‚ Perceptual   â”‚                    â”‚
â”‚  â”‚ å½“å‰å¯¹è¯å†…å®¹  â”‚  â”‚ ç¯å¢ƒæ„ŸçŸ¥ä¿¡æ¯  â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â†“                  â†“                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚  æƒ…æ™¯è®°å¿†     â”‚  â”‚  è¯­ä¹‰è®°å¿†     â”‚  â† é•¿æœŸã€æŒä¹…     â”‚
â”‚  â”‚ Episodic     â”‚  â”‚ Semantic     â”‚                    â”‚
â”‚  â”‚ äº‹ä»¶å’Œç»å†    â”‚  â”‚ çŸ¥è¯†å’Œæ¦‚å¿µ    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â†“                  â†“                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚      SQLite + Markdown          â”‚                   â”‚
â”‚  â”‚      æŒä¹…åŒ–å­˜å‚¨                  â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1ï¸âƒ£ å·¥ä½œè®°å¿† (Working Memory)

### æ¦‚å¿µ
å·¥ä½œè®°å¿†æ˜¯**å½“å‰å¯¹è¯çš„ä¸´æ—¶ç¼“å­˜**ï¼Œå°±åƒä½ çš„"çŸ­æœŸè®°å¿†"ã€‚

### ç‰¹ç‚¹
- â±ï¸ **ä¸´æ—¶æ€§**: å¯¹è¯ç»“æŸåæ¸…ç©º
- ğŸš€ **å¿«é€Ÿ**: å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè®¿é—®æå¿«
- ğŸ“ **æœ‰é™**: é€šå¸¸åªä¿ç•™æœ€è¿‘10-20æ¡æ¶ˆæ¯
- ğŸ¯ **èšç„¦**: åªå…³æ³¨å½“å‰ä¼šè¯

### å­˜å‚¨å†…å®¹
```python
{
    "role": "user",           # è§’è‰²: user/assistant
    "content": "ä½ å¥½",        # æ¶ˆæ¯å†…å®¹
    "timestamp": "2026-01-17T14:30:00"  # æ—¶é—´æˆ³
}
```

### ä½¿ç”¨åœºæ™¯
```python
# åœºæ™¯1: å¯¹è¯ä¸Šä¸‹æ–‡
ç”¨æˆ·: "æˆ‘æƒ³ä¹°ä¸€æŠŠå‰‘"
NPC: "å¥½çš„ï¼Œä»€ä¹ˆæè´¨çš„ï¼Ÿ"
ç”¨æˆ·: "é“çš„"  # NPCéœ€è¦è®°ä½å‰é¢è¯´çš„"å‰‘"
NPC: "é“å‰‘50é‡‘å¸"

# åœºæ™¯2: ä»£è¯ç†è§£
ç”¨æˆ·: "è€é“åŒ åœ¨å“ªï¼Ÿ"
NPC: "åœ¨é“åŒ é“º"
ç”¨æˆ·: "ä»–å‡ ç‚¹å¼€é—¨ï¼Ÿ"  # "ä»–"æŒ‡ä»£"è€é“åŒ "
NPC: "æ—©ä¸Š8ç‚¹"
```

### ä»£ç ç¤ºä¾‹
```python
from npc_system import MemoryTool, MemoryConfig

# åˆ›å»ºè®°å¿†å·¥å…·
memory = MemoryTool(MemoryConfig(
    data_dir="./npc_data"
))

# æ·»åŠ å·¥ä½œè®°å¿†
memory.execute(
    "add",
    content="ç”¨æˆ·è¯¢é—®äº†é“å‰‘çš„ä»·æ ¼",
    memory_type="working",
    importance=0.5
)

# æŸ¥è¯¢å·¥ä½œè®°å¿†
results = memory.execute(
    "search",
    query="ä»·æ ¼",
    memory_type="working"
)
```

### æ•°æ®æµè½¬
```
ç”¨æˆ·æ¶ˆæ¯ â†’ å·¥ä½œè®°å¿† â†’ ç”Ÿæˆå›å¤ â†’ å·¥ä½œè®°å¿†
                â†“
         (é‡è¦çš„è½¬ä¸ºæƒ…æ™¯è®°å¿†)
```

---

## 2ï¸âƒ£ æƒ…æ™¯è®°å¿† (Episodic Memory)

### æ¦‚å¿µ
æƒ…æ™¯è®°å¿†æ˜¯**äº‹ä»¶å’Œç»å†çš„è®°å½•**ï¼Œå°±åƒä½ çš„"æ—¥è®°"ã€‚

### ç‰¹ç‚¹
- ğŸ“… **æ—¶åºæ€§**: æŒ‰æ—¶é—´é¡ºåºè®°å½•
- ğŸ­ **æƒ…å¢ƒæ€§**: åŒ…å«äººç‰©ã€åœ°ç‚¹ã€äº‹ä»¶
- ğŸ’¾ **æŒä¹…æ€§**: æ°¸ä¹…ä¿å­˜åœ¨æ•°æ®åº“
- â­ **é‡è¦æ€§**: æ ¹æ®é‡è¦æ€§ç­›é€‰

### å­˜å‚¨å†…å®¹
```python
{
    "content": "ç©å®¶å¸®åŠ©NPCå‡»é€€äº†å¼ºç›—",
    "timestamp": "2026-01-17T15:30:00",
    "importance": 0.9,  # é‡è¦æ€§è¯„åˆ† (0-1)
    "participants": ["player_001", "blacksmith"],
    "location": "é“åŒ é“º",
    "emotion": "æ„Ÿæ¿€",
    "metadata": {
        "event_type": "combat_help",
        "outcome": "success"
    }
}
```

### ä½¿ç”¨åœºæ™¯
```python
# åœºæ™¯1: å›å¿†è¿‡å»
ç”¨æˆ·: "ä½ è¿˜è®°å¾—æˆ‘å—ï¼Ÿ"
NPC: "å½“ç„¶ï¼ä¸Šæ¬¡ä½ å¸®æˆ‘å‡»é€€äº†å¼ºç›—ï¼Œæˆ‘å¾ˆæ„Ÿæ¿€ã€‚"
     # â†‘ ä»æƒ…æ™¯è®°å¿†ä¸­æ£€ç´¢

# åœºæ™¯2: å…³ç³»å‘å±•
ç”¨æˆ·: "æˆ‘ä»¬è§è¿‡å‡ æ¬¡äº†ï¼Ÿ"
NPC: "è¿™æ˜¯ç¬¬5æ¬¡äº†ï¼Œæ¯æ¬¡è§åˆ°ä½ éƒ½å¾ˆé«˜å…´ã€‚"
     # â†‘ ç»Ÿè®¡æƒ…æ™¯è®°å¿†ä¸­çš„äº’åŠ¨æ¬¡æ•°

# åœºæ™¯3: äº‹ä»¶è¿½æº¯
ç”¨æˆ·: "ä¸Šæ¬¡ä½ è¯´çš„é‚£ä¸ªç§˜å¯†æ˜¯ä»€ä¹ˆï¼Ÿ"
NPC: "å“¦ï¼Œæˆ‘è¯´è¿‡é•‡å¤–æœ‰ä¸ªå±±æ´..."
     # â†‘ æ£€ç´¢å†å²å¯¹è¯
```

### ä»£ç ç¤ºä¾‹
```python
# æ·»åŠ æƒ…æ™¯è®°å¿†
memory.execute(
    "add",
    content="ç©å®¶player_001å¸®åŠ©å‡»é€€å¼ºç›—",
    memory_type="episodic",
    importance=0.9,
    user_id="player_001",
    metadata={
        "event_type": "combat_help",
        "location": "é“åŒ é“º",
        "emotion": "æ„Ÿæ¿€"
    }
)

# æ£€ç´¢ç›¸å…³æƒ…æ™¯
results = memory.execute(
    "search",
    query="å¼ºç›—",
    memory_type="episodic",
    user_id="player_001",
    limit=5
)

# ç»“æœç¤ºä¾‹
for item in results:
    print(f"[{item.timestamp}] {item.content} (é‡è¦æ€§: {item.importance})")
```

### é‡è¦æ€§è¯„åˆ†è§„åˆ™
```python
é‡è¦æ€§ = åŸºç¡€åˆ† + æƒ…æ„Ÿå¼ºåº¦ + åæœå½±å“

0.9-1.0: é‡å¤§äº‹ä»¶ (ç”Ÿæ­»ã€èƒŒå›ã€é‡è¦å†³å®š)
0.7-0.8: é‡è¦äº‹ä»¶ (ä»»åŠ¡å®Œæˆã€ç¤¼ç‰©ã€å†²çª)
0.5-0.6: ä¸€èˆ¬äº‹ä»¶ (æ™®é€šå¯¹è¯ã€äº¤æ˜“)
0.3-0.4: æ¬¡è¦äº‹ä»¶ (é—®è·¯ã€é—²èŠ)
0.1-0.2: çç¢äº‹ä»¶ (æ‰“æ‹›å‘¼)
```

### å­˜å‚¨ä½ç½®
```
npc_data/
â”œâ”€â”€ databases/
â”‚   â””â”€â”€ npc_memory.db          # SQLiteæ•°æ®åº“
â”‚       â””â”€â”€ episodic_memoryè¡¨
â””â”€â”€ memories/
    â””â”€â”€ episodic/
        â””â”€â”€ {npc_id}/
            â””â”€â”€ {player_id}/
                â””â”€â”€ event_20260117_153000.md  # Markdownæ–‡ä»¶
```

---

## 3ï¸âƒ£ è¯­ä¹‰è®°å¿† (Semantic Memory)

### æ¦‚å¿µ
è¯­ä¹‰è®°å¿†æ˜¯**çŸ¥è¯†å’Œæ¦‚å¿µçš„å­˜å‚¨**ï¼Œå°±åƒä½ çš„"ç™¾ç§‘å…¨ä¹¦"ã€‚

### ç‰¹ç‚¹
- ğŸ“š **çŸ¥è¯†æ€§**: å­˜å‚¨äº‹å®ã€æ¦‚å¿µã€è§„åˆ™
- ğŸ”— **å…³è”æ€§**: çŸ¥è¯†ä¹‹é—´æœ‰è”ç³»
- ğŸŒ **é€šç”¨æ€§**: ä¸ä¾èµ–ç‰¹å®šäº‹ä»¶
- ğŸ“ **å¯å­¦ä¹ **: å¯ä»¥ä¸æ–­æ·»åŠ æ–°çŸ¥è¯†

### å­˜å‚¨å†…å®¹
```python
{
    "content": "é“å‰‘éœ€è¦3å—é“é”­å’Œ1æ ¹æœ¨æ£åˆ¶ä½œ",
    "topic": "æ­¦å™¨é”»é€ ",
    "concepts": ["é“å‰‘", "é“é”­", "æœ¨æ£", "é”»é€ "],
    "importance": 0.8,
    "source": "å·¥ä½œç»éªŒ",
    "metadata": {
        "category": "crafting",
        "difficulty": "basic"
    }
}
```

### ä½¿ç”¨åœºæ™¯
```python
# åœºæ™¯1: ä¸“ä¸šçŸ¥è¯†
ç”¨æˆ·: "æ€ä¹ˆæ‰“é€ é“å‰‘ï¼Ÿ"
NPC: "éœ€è¦3å—é“é”­å’Œ1æ ¹æœ¨æ£ï¼Œåœ¨ç†”ç‚‰ä¸­åŠ çƒ­åé”»æ‰“æˆå‹ã€‚"
     # â†‘ ä»è¯­ä¹‰è®°å¿†ä¸­æ£€ç´¢é”»é€ çŸ¥è¯†

# åœºæ™¯2: æ¦‚å¿µè§£é‡Š
ç”¨æˆ·: "ä»€ä¹ˆæ˜¯æ·¬ç«ï¼Ÿ"
NPC: "æ·¬ç«æ˜¯å°†åŠ çƒ­çš„é‡‘å±å¿«é€Ÿå†·å´ï¼Œä½¿å…¶å˜ç¡¬çš„å·¥è‰ºã€‚"
     # â†‘ æ£€ç´¢ä¸“ä¸šæœ¯è¯­

# åœºæ™¯3: å…³è”æ¨ç†
ç”¨æˆ·: "æˆ‘æƒ³è¦æ›´é”‹åˆ©çš„å‰‘"
NPC: "é‚£ä½ éœ€è¦ç²¾é’¢ï¼Œæ¯”æ™®é€šé“æ›´ç¡¬ï¼Œä½†ä¹Ÿæ›´éš¾é”»é€ ã€‚"
     # â†‘ å…³è”"é”‹åˆ©"â†’"æè´¨"â†’"ç²¾é’¢"
```

### ä»£ç ç¤ºä¾‹
```python
# æ·»åŠ è¯­ä¹‰è®°å¿†
memory.execute(
    "add",
    content="é“å‰‘éœ€è¦3å—é“é”­å’Œ1æ ¹æœ¨æ£åˆ¶ä½œï¼Œåœ¨ç†”ç‚‰ä¸­åŠ çƒ­è‡³çº¢çƒ­çŠ¶æ€ï¼Œç„¶åé”»æ‰“æˆå‹",
    memory_type="semantic",
    importance=0.8,
    concepts=["é“å‰‘", "é“é”­", "æœ¨æ£", "é”»é€ ", "ç†”ç‚‰"],
    metadata={
        "topic": "æ­¦å™¨é”»é€ ",
        "category": "crafting"
    }
)

# æ£€ç´¢çŸ¥è¯†
results = memory.execute(
    "search",
    query="å¦‚ä½•åˆ¶ä½œé“å‰‘",
    memory_type="semantic",
    limit=3
)

# æŒ‰æ¦‚å¿µæ£€ç´¢
results = memory.execute(
    "search_by_concept",
    concepts=["é”»é€ ", "é“å‰‘"]
)
```

### çŸ¥è¯†ç»„ç»‡
```
è¯­ä¹‰è®°å¿†ç½‘ç»œ:

æ­¦å™¨é”»é€ 
â”œâ”€â”€ é“å‰‘
â”‚   â”œâ”€â”€ ææ–™: é“é”­(3) + æœ¨æ£(1)
â”‚   â”œâ”€â”€ å·¥å…·: ç†”ç‚‰ã€é“ç §ã€é”¤å­
â”‚   â”œâ”€â”€ å·¥è‰º: åŠ çƒ­ â†’ é”»æ‰“ â†’ æ·¬ç« â†’ æ‰“ç£¨
â”‚   â””â”€â”€ å±æ€§: æ”»å‡»åŠ›30, è€ä¹…åº¦100
â”œâ”€â”€ ç²¾é’¢å‰‘
â”‚   â”œâ”€â”€ ææ–™: ç²¾é’¢é”­(3) + ä¼˜è´¨æœ¨æ(1)
â”‚   â””â”€â”€ ...
â””â”€â”€ ...
```

### å­˜å‚¨ä½ç½®
```
npc_data/
â”œâ”€â”€ databases/
â”‚   â””â”€â”€ npc_memory.db
â”‚       â””â”€â”€ semantic_memoryè¡¨
â””â”€â”€ memories/
    â””â”€â”€ semantic/
        â””â”€â”€ {npc_id}/
            â”œâ”€â”€ knowledge_æ­¦å™¨é”»é€ .md
            â”œâ”€â”€ knowledge_ææ–™çŸ¥è¯†.md
            â””â”€â”€ knowledge_é•‡ä¸Šå†å².md
```

---

## 4ï¸âƒ£ æ„ŸçŸ¥è®°å¿† (Perceptual Memory)

### æ¦‚å¿µ
æ„ŸçŸ¥è®°å¿†æ˜¯**ç¯å¢ƒå’Œæ„Ÿå®˜ä¿¡æ¯**ï¼Œå°±åƒä½ çš„"äº”æ„Ÿ"ã€‚

### ç‰¹ç‚¹
- ğŸ‘ï¸ **å®æ—¶æ€§**: åæ˜ å½“å‰ç¯å¢ƒ
- ğŸŒ¡ï¸ **æ„Ÿå®˜æ€§**: è§†è§‰ã€å¬è§‰ã€è§¦è§‰ç­‰
- âš¡ **æ˜“å˜æ€§**: éšç¯å¢ƒå˜åŒ–è€Œæ›´æ–°
- ğŸ¯ **æƒ…å¢ƒæ€§**: å½±å“NPCè¡Œä¸º

### å­˜å‚¨å†…å®¹
```python
{
    "type": "visual",  # æ„ŸçŸ¥ç±»å‹: visual/audio/tactile/olfactory
    "content": "é“åŒ é“ºå†…çƒŸé›¾å¼¥æ¼«ï¼Œç†”ç‚‰ç«å…‰é€šçº¢",
    "timestamp": "2026-01-17T15:30:00",
    "intensity": 0.7,  # å¼ºåº¦
    "metadata": {
        "location": "é“åŒ é“º",
        "weather": "æ™´å¤©",
        "time_of_day": "ä¸‹åˆ"
    }
}
```

### ä½¿ç”¨åœºæ™¯
```python
# åœºæ™¯1: ç¯å¢ƒæè¿°
ç”¨æˆ·: "è¿™é‡Œæ˜¯ä»€ä¹ˆåœ°æ–¹ï¼Ÿ"
NPC: "è¿™æ˜¯æˆ‘çš„é“åŒ é“ºï¼Œä½ çœ‹ï¼Œç†”ç‚‰æ­£çƒ§å¾—æ—ºå‘¢ã€‚"
     # â†‘ æ„ŸçŸ¥åˆ°ç†”ç‚‰çš„ç«å…‰å’Œçƒ­åº¦

# åœºæ™¯2: æƒ…å¢ƒååº”
ç”¨æˆ·: "å¤–é¢ä¸‹é›¨äº†"
NPC: "æ˜¯å•Šï¼Œæˆ‘å¬åˆ°é›¨å£°äº†ã€‚ä¸‹é›¨å¤©ä¸é€‚åˆé”»é€ ï¼Œæ¹¿æ°”å¤ªé‡ã€‚"
     # â†‘ æ„ŸçŸ¥åˆ°é›¨å£°ï¼Œç»“åˆä¸“ä¸šçŸ¥è¯†å›åº”

# åœºæ™¯3: æ—¶é—´æ„ŸçŸ¥
ç”¨æˆ·: "ç°åœ¨å‡ ç‚¹äº†ï¼Ÿ"
NPC: "çœ‹å¤©è‰²ï¼Œåº”è¯¥æ˜¯ä¸‹åˆ3ç‚¹å·¦å³äº†ã€‚"
     # â†‘ æ„ŸçŸ¥åˆ°å…‰çº¿å’Œæ—¶é—´
```

### ä»£ç ç¤ºä¾‹
```python
# æ·»åŠ æ„ŸçŸ¥è®°å¿†
memory.execute(
    "add",
    content="é“åŒ é“ºå†…æ¸©åº¦å¾ˆé«˜ï¼Œç†”ç‚‰ç«å…‰é€šçº¢ï¼Œç©ºæ°”ä¸­æœ‰é‡‘å±çš„å‘³é“",
    memory_type="perceptual",
    importance=0.5,
    metadata={
        "location": "é“åŒ é“º",
        "sensory_type": ["visual", "olfactory", "tactile"],
        "time_of_day": "ä¸‹åˆ"
    }
)

# æ›´æ–°ç¯å¢ƒæ„ŸçŸ¥
memory.execute(
    "update_perception",
    location="é“åŒ é“º",
    weather="ä¸‹é›¨",
    time_of_day="å‚æ™š",
    ambient_sound="é›¨å£°"
)

# æŸ¥è¯¢å½“å‰ç¯å¢ƒ
perception = memory.execute(
    "get_current_perception"
)
```

### æ„ŸçŸ¥ç±»å‹
```python
æ„ŸçŸ¥ç±»å‹:
â”œâ”€â”€ visual (è§†è§‰)
â”‚   â”œâ”€â”€ å…‰çº¿: æ˜äº®/æ˜æš—
â”‚   â”œâ”€â”€ é¢œè‰²: ç«å…‰é€šçº¢
â”‚   â””â”€â”€ ç‰©ä½“: ç†”ç‚‰ã€é“ç §
â”œâ”€â”€ audio (å¬è§‰)
â”‚   â”œâ”€â”€ ç¯å¢ƒéŸ³: é›¨å£°ã€é£å£°
â”‚   â”œâ”€â”€ äººå£°: å¯¹è¯ã€å–Šå«
â”‚   â””â”€â”€ å·¥ä½œéŸ³: é”¤æ‰“å£°
â”œâ”€â”€ tactile (è§¦è§‰)
â”‚   â”œâ”€â”€ æ¸©åº¦: ç‚çƒ­ã€å¯’å†·
â”‚   â”œâ”€â”€ æ¹¿åº¦: æ½®æ¹¿ã€å¹²ç‡¥
â”‚   â””â”€â”€ è´¨æ„Ÿ: ç²—ç³™ã€å…‰æ»‘
â”œâ”€â”€ olfactory (å—…è§‰)
â”‚   â”œâ”€â”€ æ°”å‘³: é‡‘å±å‘³ã€çƒŸå‘³
â”‚   â””â”€â”€ å¼ºåº¦: æµ“çƒˆã€æ·¡æ·¡
â””â”€â”€ emotional (æƒ…æ„Ÿæ„ŸçŸ¥)
    â”œâ”€â”€ æ°›å›´: ç´§å¼ ã€è½»æ¾
    â””â”€â”€ ä»–äººæƒ…ç»ª: æ„¤æ€’ã€å–œæ‚¦
```

---

## ğŸ”„ è®°å¿†æµè½¬æœºåˆ¶

### 1. è®°å¿†å½¢æˆæµç¨‹
```
å¯¹è¯è¾“å…¥
    â†“
å·¥ä½œè®°å¿† (ä¸´æ—¶å­˜å‚¨)
    â†“
é‡è¦æ€§è¯„ä¼°
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â†“                   â†“
æƒ…æ™¯è®°å¿†          è¯­ä¹‰è®°å¿†
(äº‹ä»¶)            (çŸ¥è¯†)
    â†“                   â†“
æŒä¹…åŒ–å­˜å‚¨ (SQLite + Markdown)
```

### 2. è®°å¿†æ£€ç´¢æµç¨‹
```
ç”¨æˆ·æŸ¥è¯¢
    â†“
ç›¸å…³æ€§è®¡ç®—
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â†“         â†“         â†“         â†“
å·¥ä½œè®°å¿†  æƒ…æ™¯è®°å¿†  è¯­ä¹‰è®°å¿†  æ„ŸçŸ¥è®°å¿†
    â†“         â†“         â†“         â†“
åˆå¹¶æ’åº (æŒ‰ç›¸å…³æ€§ + æ—¶é—´)
    â†“
è¿”å›Top-Kç»“æœ
```

### 3. è®°å¿†å·©å›º
```python
# å®šæœŸå°†é‡è¦çš„å·¥ä½œè®°å¿†è½¬ä¸ºé•¿æœŸè®°å¿†
def consolidate_memory():
    # 1. è·å–å·¥ä½œè®°å¿†
    working_memories = memory.get_working_memories()
    
    # 2. è¯„ä¼°é‡è¦æ€§
    for mem in working_memories:
        if mem.importance > 0.7:
            # 3. è½¬ä¸ºæƒ…æ™¯è®°å¿†
            memory.add_episodic(mem)
        
        if is_knowledge(mem):
            # 4. æå–çŸ¥è¯†ï¼Œè½¬ä¸ºè¯­ä¹‰è®°å¿†
            knowledge = extract_knowledge(mem)
            memory.add_semantic(knowledge)
    
    # 5. æ¸…ç†å·¥ä½œè®°å¿†
    memory.clear_working()
```

---

## ğŸ’¾ å­˜å‚¨å®ç°

### SQLiteæ•°æ®åº“ç»“æ„
```sql
-- è®°å¿†è¡¨
CREATE TABLE memories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    memory_id TEXT UNIQUE,
    npc_id TEXT,
    player_id TEXT,
    memory_type TEXT,  -- working/episodic/semantic/perceptual
    content TEXT,
    importance REAL,
    timestamp TEXT,
    concepts TEXT,     -- JSONæ•°ç»„
    metadata TEXT,     -- JSONå¯¹è±¡
    embedding BLOB,    -- å‘é‡åµŒå…¥(å¯é€‰)
    created_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_memory_type ON memories(memory_type);
CREATE INDEX idx_memory_npc ON memories(npc_id);
CREATE INDEX idx_memory_player ON memories(npc_id, player_id);
CREATE INDEX idx_memory_importance ON memories(importance);
CREATE INDEX idx_memory_timestamp ON memories(timestamp);
```

### Markdownæ–‡ä»¶æ ¼å¼
```markdown
---
memory_id: mem_20260117_153000_abc123
memory_type: episodic
npc_id: blacksmith
player_id: player_001
importance: 0.9
timestamp: 2026-01-17T15:30:00
concepts: ["æˆ˜æ–—", "å¸®åŠ©", "å¼ºç›—"]
location: é“åŒ é“º
emotion: æ„Ÿæ¿€
---

# ç©å®¶å¸®åŠ©å‡»é€€å¼ºç›—

ä»Šå¤©ä¸‹åˆï¼Œä¸€ç¾¤å¼ºç›—é—¯å…¥é“åŒ é“ºæƒ³è¦æŠ¢åŠ«ã€‚å¹¸å¥½player_001åŠæ—¶å‡ºç°ï¼Œ
å¸®æˆ‘å‡»é€€äº†ä»–ä»¬ã€‚æˆ‘éå¸¸æ„Ÿæ¿€ï¼Œå†³å®šé€ä»–ä¸€æŠŠç²¾å¿ƒæ‰“é€ çš„é“å‰‘ä½œä¸ºè°¢ç¤¼ã€‚

è¿™æ¬¡äº‹ä»¶è®©æˆ‘æ„è¯†åˆ°ï¼Œè¿™ä¸ªé•‡å­éœ€è¦æ›´å¥½çš„é˜²å«ã€‚æˆ‘ä¼šå’Œå®ˆå«é˜Ÿé•¿å•†é‡
åŠ å¼ºå·¡é€»ã€‚

## å‚ä¸è€…
- player_001: è‹±å‹‡çš„å†’é™©è€…
- blacksmith: æˆ‘è‡ªå·±
- å¼ºç›—å›¢ä¼™: çº¦5äºº

## ç»“æœ
- å¼ºç›—è¢«å‡»é€€
- é“åŒ é“ºå®‰å…¨
- ä¸player_001çš„å…³ç³»å¤§å¹…æå‡
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´å¯¹è¯ç¤ºä¾‹
```python
from npc_system import create_npc
from langchain_ollama import ChatOllama

# åˆ›å»ºNPC
llm = ChatOllama(model="qwen2.5")
npc = create_npc(
    npc_id="blacksmith",
    name="è€é“åŒ ",
    role="é“åŒ ",
    traits=["ä¸¥è‚ƒ", "ä¸“ä¸š", "è®°æ€§å¥½"],
    llm=llm
)

# ç¬¬1æ¬¡å¯¹è¯
result1 = npc.chat("player_001", "ä½ å¥½ï¼Œæˆ‘æƒ³ä¹°ä¸€æŠŠå‰‘")
# NPC: "ä½ å¥½ï¼Œæˆ‘è¿™é‡Œæœ‰é“å‰‘å’Œç²¾é’¢å‰‘..."
# â†’ å·¥ä½œè®°å¿†: ç”¨æˆ·æƒ³ä¹°å‰‘

# ç¬¬2æ¬¡å¯¹è¯
result2 = npc.chat("player_001", "é“å‰‘å¤šå°‘é’±ï¼Ÿ")
# NPC: "é“å‰‘50é‡‘å¸"
# â†’ å·¥ä½œè®°å¿†: è¯¢é—®ä»·æ ¼

# ç¬¬3æ¬¡å¯¹è¯
result3 = npc.chat("player_001", "å¥½çš„ï¼Œæˆ‘ä¹°äº†")
# NPC: "æˆäº¤ï¼è¿™æŠŠå‰‘æ˜¯æˆ‘ç²¾å¿ƒæ‰“é€ çš„..."
# â†’ æƒ…æ™¯è®°å¿†: ç©å®¶è´­ä¹°äº†é“å‰‘ (importance=0.7)
# â†’ è¯­ä¹‰è®°å¿†: é“å‰‘ä»·æ ¼50é‡‘å¸

# å‡ å¤©å...
result4 = npc.chat("player_001", "ä½ è¿˜è®°å¾—æˆ‘å—ï¼Ÿ")
# NPC: "å½“ç„¶ï¼ä½ ä¸Šæ¬¡ä¹°äº†æˆ‘çš„é“å‰‘ï¼Œç”¨å¾—æ€ä¹ˆæ ·ï¼Ÿ"
# â†’ ä»æƒ…æ™¯è®°å¿†ä¸­æ£€ç´¢åˆ°è´­ä¹°äº‹ä»¶
```

### è®°å¿†æ£€ç´¢ç¤ºä¾‹
```python
# æ£€ç´¢æ‰€æœ‰ä¸"å‰‘"ç›¸å…³çš„è®°å¿†
results = npc.recall("å‰‘", limit=5, user_id="player_001")

for mem in results:
    print(f"[{mem.memory_type}] {mem.content}")
    print(f"  é‡è¦æ€§: {mem.importance}")
    print(f"  æ—¶é—´: {mem.timestamp}")
    print()

# è¾“å‡º:
# [episodic] ç©å®¶player_001è´­ä¹°äº†é“å‰‘
#   é‡è¦æ€§: 0.7
#   æ—¶é—´: 2026-01-17T15:30:00
#
# [semantic] é“å‰‘éœ€è¦3å—é“é”­å’Œ1æ ¹æœ¨æ£åˆ¶ä½œ
#   é‡è¦æ€§: 0.8
#   æ—¶é—´: 2026-01-10T10:00:00
#
# [working] ç”¨æˆ·è¯¢é—®é“å‰‘ä»·æ ¼
#   é‡è¦æ€§: 0.5
#   æ—¶é—´: 2026-01-17T15:28:00
```

---

## âš™ï¸ é…ç½®é€‰é¡¹

### MemoryConfig
```python
from npc_system import MemoryConfig

config = MemoryConfig(
    # æ•°æ®ç›®å½•
    data_dir="./npc_data",
    
    # å·¥ä½œè®°å¿†é…ç½®
    working_memory_size=20,        # æœ€å¤§æ¡æ•°
    working_memory_ttl=3600,       # ç”Ÿå­˜æ—¶é—´(ç§’)
    
    # æƒ…æ™¯è®°å¿†é…ç½®
    episodic_min_importance=0.3,   # æœ€ä½é‡è¦æ€§é˜ˆå€¼
    episodic_max_age_days=365,     # æœ€å¤§ä¿ç•™å¤©æ•°
    
    # è¯­ä¹‰è®°å¿†é…ç½®
    semantic_min_importance=0.5,   # æœ€ä½é‡è¦æ€§é˜ˆå€¼
    enable_concept_linking=True,   # å¯ç”¨æ¦‚å¿µå…³è”
    
    # æ„ŸçŸ¥è®°å¿†é…ç½®
    perceptual_update_interval=60, # æ›´æ–°é—´éš”(ç§’)
    
    # æ£€ç´¢é…ç½®
    default_search_limit=10,       # é»˜è®¤è¿”å›æ•°é‡
    relevance_threshold=0.1,       # ç›¸å…³æ€§é˜ˆå€¼
    enable_embedding=False,        # å¯ç”¨å‘é‡åµŒå…¥(éœ€è¦FAISS)
    
    # å­˜å‚¨é…ç½®
    enable_markdown_export=True,   # å¯ç”¨Markdownå¯¼å‡º
    auto_consolidate=True,         # è‡ªåŠ¨å·©å›ºè®°å¿†
    consolidate_interval=300       # å·©å›ºé—´éš”(ç§’)
)
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥
```python
class MemoryTool:
    def __init__(self):
        self.search_cache = {}  # æœç´¢ç»“æœç¼“å­˜
        self.cache_ttl = 300    # 5åˆ†é’Ÿ
    
    def search(self, query):
        cache_key = f"{query}_{int(time.time() / self.cache_ttl)}"
        if cache_key in self.search_cache:
            return self.search_cache[cache_key]
        
        results = self._do_search(query)
        self.search_cache[cache_key] = results
        return results
```

### 2. ç´¢å¼•ä¼˜åŒ–
```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•
CREATE INDEX idx_memory_search 
ON memories(npc_id, player_id, memory_type, importance DESC);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE VIRTUAL TABLE memories_fts 
USING fts5(content, concepts);
```

### 3. åˆ†é¡µæŸ¥è¯¢
```python
# é¿å…ä¸€æ¬¡åŠ è½½æ‰€æœ‰è®°å¿†
results = memory.search(
    query="å‰‘",
    limit=10,      # åªè¿”å›10æ¡
    offset=0       # ä»ç¬¬0æ¡å¼€å§‹
)
```

---

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹è®°å¿†ç»Ÿè®¡
```python
stats = memory.execute("summary")
print(stats)

# è¾“å‡º:
# {
#     "working": 15,      # å·¥ä½œè®°å¿†æ•°é‡
#     "episodic": 234,    # æƒ…æ™¯è®°å¿†æ•°é‡
#     "semantic": 89,     # è¯­ä¹‰è®°å¿†æ•°é‡
#     "perceptual": 5,    # æ„ŸçŸ¥è®°å¿†æ•°é‡
#     "total": 343,
#     "db_size_mb": 2.5
# }
```

### å¯¼å‡ºè®°å¿†
```python
# å¯¼å‡ºä¸ºJSON
memory.export_to_json("memory_backup.json")

# å¯¼å‡ºä¸ºMarkdown
memory.export_to_markdown("./memory_export/")
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. åˆç†è®¾ç½®é‡è¦æ€§
```python
# é‡å¤§äº‹ä»¶
importance = 0.9  # ç”Ÿæ­»ã€èƒŒå›ã€é‡è¦å†³å®š

# é‡è¦äº‹ä»¶
importance = 0.7  # ä»»åŠ¡å®Œæˆã€ç¤¼ç‰©ã€å†²çª

# ä¸€èˆ¬äº‹ä»¶
importance = 0.5  # æ™®é€šå¯¹è¯ã€äº¤æ˜“

# çç¢äº‹ä»¶
importance = 0.3  # é—®è·¯ã€é—²èŠ
```

### 2. å®šæœŸæ¸…ç†
```python
# æ¸…ç†è¿‡æœŸçš„å·¥ä½œè®°å¿†
memory.cleanup_working_memory(max_age_seconds=3600)

# æ¸…ç†ä½é‡è¦æ€§çš„æƒ…æ™¯è®°å¿†
memory.cleanup_episodic_memory(min_importance=0.3)
```

### 3. æ¦‚å¿µæ ‡æ³¨
```python
# ä¸ºè¯­ä¹‰è®°å¿†æ·»åŠ æ¦‚å¿µæ ‡ç­¾
memory.add_semantic(
    content="é“å‰‘éœ€è¦3å—é“é”­åˆ¶ä½œ",
    concepts=["é“å‰‘", "é“é”­", "é”»é€ ", "æ­¦å™¨"]  # ä¾¿äºæ£€ç´¢
)
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [06-RAGç³»ç»Ÿè¯¦è§£](./06-RAG_SYSTEM.md) - çŸ¥è¯†åº“æ£€ç´¢
- [07-ä¸Šä¸‹æ–‡æ„å»ºè¯¦è§£](./07-CONTEXT_BUILDER.md) - å¦‚ä½•ä½¿ç”¨è®°å¿†
- [09-å¯¹è¯å­˜å‚¨è¯¦è§£](./09-DIALOGUE_STORAGE.md) - å¯¹è¯è®°å½•å­˜å‚¨
- [10-NPCæ™ºèƒ½ä½“è¯¦è§£](./10-NPC_AGENT.md) - è®°å¿†åœ¨Agentä¸­çš„åº”ç”¨

---

æ­å–œï¼ä½ ç°åœ¨å·²ç»å®Œå…¨ç†è§£äº†NPCçš„è®°å¿†ç³»ç»Ÿï¼ğŸ‰
