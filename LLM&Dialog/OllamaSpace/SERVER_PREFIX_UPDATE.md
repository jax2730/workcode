# âœ… æœåŠ¡å™¨å‰ç¼€åŠŸèƒ½å·²æ·»åŠ 

## ğŸ¯ æ›´æ–°å†…å®¹

åœ¨ç”Ÿæˆçš„ `npc_id` ä¸­æ·»åŠ äº†**æœåŠ¡å™¨éšæœºå‰ç¼€**ï¼Œä½¿ ID æ›´åŠ ç¬¦åˆå·¥ç¨‹è§„èŒƒã€‚

---

## ğŸ“ ID æ ¼å¼å˜åŒ–

### ä¹‹å‰çš„æ ¼å¼
```
{planner_id}_{role_type}
ä¾‹å¦‚ï¼š1e23_tavern_owner_cn
```

### ç°åœ¨çš„æ ¼å¼
```
{server_prefix}_{planner_id}_{role_type}
ä¾‹å¦‚ï¼ša1b2c3d4_1e23_tavern_owner_cn
```

å…¶ä¸­ `server_prefix` æ˜¯æœåŠ¡å™¨ç”Ÿæˆçš„ **8ä½éšæœºåå…­è¿›åˆ¶å­—ç¬¦**ã€‚

---

## âœ¨ ä¼˜åŠ¿

### 1. å…¨å±€å”¯ä¸€æ€§
- âœ… æœåŠ¡å™¨å‰ç¼€ç¡®ä¿æ¯ä¸ª `npc_id` éƒ½æ˜¯å…¨å±€å”¯ä¸€çš„
- âœ… å³ä½¿ä¸åŒæœåŠ¡å™¨å®ä¾‹ä¹Ÿä¸ä¼šå†²çª

### 2. æ›´çµæ´»çš„åˆ›å»º
- âœ… åŒä¸€ç­–åˆ’å¯ä»¥åˆ›å»ºå¤šä¸ªç›¸åŒ `role_type` çš„è§’è‰²
- âœ… æ¯æ¬¡åˆ›å»ºéƒ½ä¼šç”Ÿæˆä¸åŒçš„éšæœºå‰ç¼€

### 3. å¯è¿½æº¯æ€§
- âœ… é€šè¿‡å‰ç¼€å¯ä»¥è¯†åˆ«è¿™æ˜¯æœåŠ¡å™¨ç”Ÿæˆçš„ ID
- âœ… é€šè¿‡ `planner_id` å¯ä»¥è¿½æº¯åˆ›å»ºè€…
- âœ… é€šè¿‡ `role_type` å¯ä»¥è¯†åˆ«è§’è‰²ç±»å‹

---

## ğŸ”§ ä»£ç ä¿®æ”¹

### ä¿®æ”¹çš„æ–‡ä»¶
- `extrator/llm/persona_api.py`

### ä¿®æ”¹çš„æ–¹æ³•
1. **æ–°å¢ `generate_server_prefix()`**
   ```python
   @classmethod
   def generate_server_prefix(cls) -> str:
       """ç”ŸæˆæœåŠ¡å™¨å”¯ä¸€å‰ç¼€ï¼ˆ8ä½éšæœºå­—ç¬¦ï¼‰"""
       return secrets.token_hex(4)  # ç”Ÿæˆ8ä½åå…­è¿›åˆ¶å­—ç¬¦
   ```

2. **ä¿®æ”¹ `generate_npc_id()`**
   ```python
   @classmethod
   def generate_npc_id(cls, planner_id: str, role_type: str) -> str:
       """ç”Ÿæˆå”¯ä¸€çš„ NPC IDï¼Œæ ¼å¼ï¼š{server_prefix}_{planner_id}_{role_type}"""
       server_prefix = cls.generate_server_prefix()
       return f"{server_prefix}_{planner_id}_{role_type}"
   ```

3. **ä¿®æ”¹ `create_persona()`**
   - ç§»é™¤äº†é‡å¤åˆ›å»ºæ£€æŸ¥
   - å› ä¸ºæœ‰éšæœºå‰ç¼€ï¼Œæ¯æ¬¡éƒ½æ˜¯å”¯ä¸€çš„

---

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºè§’è‰²
```powershell
Invoke-RestMethod -Uri "http://192.168.5.189:8000/api/persona/" -Method Post -Body @{
    planner_id = "1e23"
    role_type = "tavern_owner_cn"
    name = "æè€æ¿"
    role = "é…’é¦†è€æ¿"
}
```

### è¿”å›ç»“æœ
```json
{
    "success": true,
    "code": 201,
    "data": {
        "npc_id": "a1b2c3d4_1e23_tavern_owner_cn",  // â† åŒ…å«éšæœºå‰ç¼€
        "planner_id": "1e23",
        "role_type": "tavern_owner_cn",
        ...
    }
}
```

### å¤šæ¬¡åˆ›å»ºç›¸åŒè§’è‰²
```powershell
# ç¬¬ä¸€æ¬¡åˆ›å»º
Invoke-RestMethod ... # è¿”å›: a1b2c3d4_1e23_tavern_owner_cn

# ç¬¬äºŒæ¬¡åˆ›å»ºï¼ˆç›¸åŒçš„ planner_id å’Œ role_typeï¼‰
Invoke-RestMethod ... # è¿”å›: e5f6g7h8_1e23_tavern_owner_cn âœ… ä¸ä¼šå†²çª

# ç¬¬ä¸‰æ¬¡åˆ›å»º
Invoke-RestMethod ... # è¿”å›: i9j0k1l2_1e23_tavern_owner_cn âœ… ä¸ä¼šå†²çª
```

---

## ğŸ”„ è¡Œä¸ºå˜åŒ–

### ä¹‹å‰
- âŒ åŒä¸€ç­–åˆ’ä¸èƒ½åˆ›å»ºå¤šä¸ªç›¸åŒ `role_type` çš„è§’è‰²
- âŒ é‡å¤åˆ›å»ºä¼šè¿”å› 409 é”™è¯¯

### ç°åœ¨
- âœ… åŒä¸€ç­–åˆ’å¯ä»¥åˆ›å»ºå¤šä¸ªç›¸åŒ `role_type` çš„è§’è‰²
- âœ… æ¯æ¬¡åˆ›å»ºéƒ½ä¼šç”Ÿæˆæ–°çš„å”¯ä¸€ ID
- âœ… ä¸ä¼šå‡ºç° 409 å†²çªé”™è¯¯

---

## ğŸ“š æ›´æ–°çš„æ–‡æ¡£

å·²æ›´æ–°ä»¥ä¸‹æ–‡æ¡£ä»¥åæ˜ æ–°çš„ ID æ ¼å¼ï¼š

1. **PERSONA_API.md**
   - æ›´æ–°äº† ID æ ¼å¼è¯´æ˜
   - æ›´æ–°äº†æ‰€æœ‰ç¤ºä¾‹
   - æ›´æ–°äº†å¸¸è§é—®é¢˜

2. **å…¶ä»–æ–‡æ¡£**
   - éœ€è¦æ—¶å¯ä»¥æ›´æ–°å…¶ä»–ç›¸å…³æ–‡æ¡£

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¿å­˜å®Œæ•´çš„ npc_id
ç­–åˆ’å¿…é¡»ä¿å­˜è¿”å›çš„**å®Œæ•´ `npc_id`**ï¼ˆåŒ…å«éšæœºå‰ç¼€ï¼‰ï¼Œç”¨äºåç»­æ“ä½œï¼š
```python
npc_id = response.json()["data"]["npc_id"]
# ä¾‹å¦‚ï¼ša1b2c3d4_1e23_tavern_owner_cn
save_to_database(npc_id)  # ä¿å­˜å®Œæ•´ID
```

### 2. ä¸è¦å°è¯•æ‰‹åŠ¨æ„é€  npc_id
ç”±äºåŒ…å«éšæœºå‰ç¼€ï¼Œä¸èƒ½é€šè¿‡ `planner_id` å’Œ `role_type` æ‰‹åŠ¨æ„é€  `npc_id`ã€‚

### 3. å‘åå…¼å®¹
æ—§çš„ `npc_id` æ ¼å¼ï¼ˆä¸å¸¦å‰ç¼€ï¼‰ä»ç„¶æ”¯æŒï¼Œç°æœ‰æ•°æ®ä¸å—å½±å“ã€‚

---

## ğŸ‰ æ€»ç»“

é€šè¿‡æ·»åŠ æœåŠ¡å™¨éšæœºå‰ç¼€ï¼š
- âœ… **å…¨å±€å”¯ä¸€æ€§** - æ¯ä¸ª ID éƒ½æ˜¯å”¯ä¸€çš„
- âœ… **æ›´çµæ´»** - å¯ä»¥åˆ›å»ºå¤šä¸ªç›¸åŒç±»å‹çš„è§’è‰²
- âœ… **æ›´ç¬¦åˆå·¥ç¨‹è§„èŒƒ** - æœåŠ¡å™¨ç”Ÿæˆçš„ ID æœ‰æ˜ç¡®æ ‡è¯†
- âœ… **å‘åå…¼å®¹** - ä¸å½±å“ç°æœ‰åŠŸèƒ½

ç°åœ¨çš„ ID æ ¼å¼æ›´åŠ å¥å£®å’Œçµæ´»ï¼ğŸš€
