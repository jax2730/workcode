# 03 - 系统架构总览

本文档从整体角度介绍NPC智能体系统的设计思路和架构。

## 🎯 设计目标

### 核心目标
1. **智能对话**: NPC能够进行自然、连贯的对话
2. **长期记忆**: 记住与玩家的所有互动历史
3. **人设一致**: 保持NPC性格和背景的一致性
4. **知识丰富**: 能够回答专业领域的问题
5. **关系发展**: 根据互动动态调整好感度

### 设计原则
- **模块化**: 每个功能独立，可单独使用
- **可扩展**: 易于添加新功能和新NPC
- **高性能**: 优化响应速度，支持并发
- **易维护**: 代码清晰，文档完善

---

## 🏗️ 整体架构

### 三层架构

```
┌─────────────────────────────────────────────────────────┐
│                    应用层 (Application)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  命令行工具   │  │  Django API  │  │  游戏集成    │  │
│  │  npc_chat.py │  │    views.py  │  │  game.py     │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────┴────────────────────────────────┐
│                    业务层 (Business)                     │
│  ┌──────────────────────────────────────────────────┐   │
│  │              NPCManager (多NPC管理)               │   │
│  │  - 统一管理多个NPC                                │   │
│  │  - 批量对话生成                                   │   │
│  │  - 场景氛围生成                                   │   │
│  └──────────────────────────────────────────────────┘   │
│                         │                                │
│  ┌──────────────────────┴──────────────────────────┐   │
│  │              NPCAgent (单个NPC)                   │   │
│  │  - 对话处理                                       │   │
│  │  - 记忆管理                                       │   │
│  │  - 知识检索                                       │   │
│  │  - 好感度计算                                     │   │
│  └──────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────┴────────────────────────────────┐
│                    工具层 (Tools)                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │MemoryTool│ │ RAGTool  │ │ NoteTool │ │Relation  │  │
│  │  记忆系统 │ │ 知识检索 │ │   笔记   │ │ 好感度   │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │         ContextBuilder (上下文构建)               │  │
│  │  - 汇集多源信息 (Gather)                         │  │
│  │  - 智能选择 (Select)                             │  │
│  │  - 结构化输出 (Structure)                        │  │
│  │  - 兜底压缩 (Compress)                           │  │
│  └──────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────┴────────────────────────────────┐
│                    存储层 (Storage)                      │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │  SQLite  │ │ Markdown │ │  Excel   │ │  FAISS   │  │
│  │  数据库  │ │   文件   │ │  导出    │ │ 向量索引 │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 🔄 数据流程

### 对话流程 (10步)

```
用户输入: "你好，能帮我打造一把剑吗？"
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ 步骤1: 接收输入                                          │
│  - 验证输入                                              │
│  - 提取player_id, session_id                            │
└────────────────────┬────────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 步骤2: 加载会话历史                                      │
│  - 从内存加载工作记忆 (最近10条)                         │
│  - 从数据库加载历史对话                                  │
└────────────────────┬────────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 步骤3: 检索记忆 (MemoryTool)                            │
│  - 工作记忆: 当前对话内容                                │
│  - 情景记忆: 与该玩家的互动历史                          │
│  - 语义记忆: NPC的知识和经验                             │
│  - 感知记忆: 当前环境信息                                │
└────────────────────┬────────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 步骤4: 检索知识 (RAGTool)                               │
│  - 从知识库检索相关文档                                  │
│  - 例如: "剑的锻造方法"、"材料价格"                      │
└────────────────────┬────────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 步骤5: 查询好感度 (RelationshipManager)                 │
│  - 获取当前好感度等级                                    │
│  - 获取可分享的秘密                                      │
└────────────────────┬────────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 步骤6: 构建上下文 (ContextBuilder - GSSC)               │
│  - Gather: 汇集所有信息                                 │
│    • 人设描述                                            │
│    • 记忆检索结果                                        │
│    • RAG检索结果                                         │
│    • 好感度信息                                          │
│    • 对话历史                                            │
│  - Select: 智能选择最相关的信息                         │
│  - Structure: 结构化组织                                │
│  - Compress: 如果超长，压缩到限制内                     │
└────────────────────┬────────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 步骤7: LLM生成回复                                       │
│  - 将上下文和用户消息发送给LLM                           │
│  - LLM基于上下文生成回复                                 │
└────────────────────┬────────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 步骤8: 更新好感度                                        │
│  - 分析对话内容                                          │
│  - 计算好感度变化 (+1~5 或 -1~5)                        │
│  - 更新数据库                                            │
└────────────────────┬────────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 步骤9: 保存对话记录                                      │
│  - SQLite: 结构化存储，便于查询                          │
│  - Markdown: 人类可读，便于审查                          │
│  - 工作记忆: 临时缓存                                    │
└────────────────────┬────────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 步骤10: 返回结果                                         │
│  {                                                       │
│    "reply": "当然可以！你想要什么样的剑？",              │
│    "affinity": {"level": "友好", "score": 65},          │
│    "npc_name": "老铁匠",                                 │
│    "session_id": "session_xxx"                           │
│  }                                                       │
└─────────────────────────────────────────────────────────┘
```

---

## 🧩 核心模块

### 1. NPCAgent (NPC智能体)

**职责**: 单个NPC的核心逻辑

**主要功能**:
- 处理对话请求
- 协调各个工具
- 管理NPC状态

**关键方法**:
```python
class NPCAgent:
    def chat(player_id, message):
        """处理对话"""
        
    def get_status(player_id):
        """获取NPC状态"""
        
    def remember(content):
        """添加记忆"""
        
    def recall(query):
        """回忆记忆"""
```

**详细文档**: [10-NPC智能体详解](./10-NPC_AGENT.md)

---

### 2. MemoryTool (记忆系统)

**职责**: 管理NPC的四层记忆

**四层记忆**:
1. **工作记忆**: 当前对话的临时信息
2. **情景记忆**: 与玩家的互动历史
3. **语义记忆**: NPC的知识和经验
4. **感知记忆**: 环境和场景信息

**存储方式**:
- SQLite数据库 (快速查询)
- Markdown文件 (人类可读)

**详细文档**: [05-记忆系统详解](./05-MEMORY_SYSTEM.md)

---

### 3. RAGTool (知识检索)

**职责**: 从知识库检索相关信息

**工作流程**:
1. 文档加载 (txt/md/json)
2. 文档分块 (500字/块)
3. 向量化 (可选)
4. 构建索引 (FAISS或简单索引)
5. 相似度检索
6. 重排序

**使用场景**:
- 专业知识问答
- 价格查询
- 制作方法
- 历史背景

**详细文档**: [06-RAG系统详解](./06-RAG_SYSTEM.md)

---

### 4. ContextBuilder (上下文构建)

**职责**: 智能构建LLM的输入上下文

**GSSC流水线**:
- **G**ather: 汇集多源信息
- **S**elect: 智能选择相关信息
- **S**tructure: 结构化组织
- **C**ompress: 兜底压缩

**为什么需要?**
- LLM有上下文长度限制 (如4096 tokens)
- 信息太多会超出限制
- 需要智能选择最相关的信息

**详细文档**: [07-上下文构建详解](./07-CONTEXT_BUILDER.md)

---

### 5. RelationshipManager (好感度系统)

**职责**: 管理NPC与玩家的关系

**好感度等级**:
- 陌生 (0-20分)
- 熟悉 (21-40分)
- 友好 (41-60分)
- 亲密 (61-80分)
- 挚友 (81-100分)

**影响因素**:
- 对话内容 (正面/负面)
- 互动频率
- 礼物赠送
- 任务完成

**详细文档**: [08-好感度系统详解](./08-RELATIONSHIP_SYSTEM.md)

---

### 6. DialogueStorage (对话存储)

**职责**: 多格式存储对话记录

**存储格式**:
- **SQLite**: 结构化查询
- **Markdown**: 人类可读
- **Excel**: 数据分析

**兼容性**:
- 兼容LangChain的SQLChatMessageHistory
- 兼容原有的general_chat.py

**详细文档**: [09-对话存储详解](./09-DIALOGUE_STORAGE.md)

---

## 🎨 设计模式

### 1. 工具模式 (Tool Pattern)

每个功能都是一个独立的"工具"，可以单独使用或组合使用。

```python
# 单独使用记忆工具
memory = MemoryTool(config)
memory.add("重要信息")
results = memory.search("查询")

# 单独使用RAG工具
rag = RAGTool(config)
results = rag.search("问题")

# 组合使用
npc = NPCAgent(memory=memory, rag=rag)
```

### 2. 配置驱动 (Configuration-Driven)

所有行为通过配置文件控制，无需修改代码。

```json
{
  "npc_id": "blacksmith",
  "personality": {
    "name": "老铁匠",
    "traits": ["严肃", "专业"]
  },
  "memory_config": {
    "working_memory_size": 20
  },
  "rag_config": {
    "enable_embedding": true
  }
}
```

### 3. 流水线模式 (Pipeline Pattern)

上下文构建使用流水线模式，每个阶段处理一部分任务。

```python
context = (
    ContextBuilder()
    .gather(sources)      # 汇集信息
    .select(relevance)    # 选择相关
    .structure(format)    # 结构化
    .compress(max_tokens) # 压缩
    .build()
)
```

### 4. 观察者模式 (Observer Pattern)

好感度变化时，触发相应的事件。

```python
# 注册监听器
relationship.on_level_up(lambda npc, player: 
    print(f"{npc}与{player}的关系升级了！")
)

# 好感度变化时自动触发
relationship.update_affinity(npc_id, player_id, +5)
# 输出: "老铁匠与player_001的关系升级了！"
```

---

## 📁 目录结构

```
npc_system/
├── docs/                          # 📚 详细文档
│   ├── README.md                  # 文档导航
│   ├── 01-QUICKSTART.md          # 快速入门
│   ├── 05-MEMORY_SYSTEM.md       # 记忆系统
│   ├── 06-RAG_SYSTEM.md          # RAG系统
│   └── ...                        # 其他文档
│
├── __init__.py                    # 模块导出
├── npc_agent.py                   # 🤖 NPC智能体
├── npc_manager.py                 # 👥 多NPC管理
├── npc_chat.py                    # 💬 命令行工具
│
├── memory_tool.py                 # 🧠 记忆系统
├── rag_tool.py                    # 📚 RAG检索
├── context_builder.py             # 🏗️ 上下文构建
├── relationship_manager.py        # ❤️ 好感度系统
├── dialogue_storage.py            # 💾 对话存储
├── note_tool.py                   # 📝 笔记工具
│
├── storage_config.py              # ⚙️ 存储配置
├── file_memory_store.py           # 📁 文件存储
├── terminal_tool.py               # 🔧 终端工具
│
├── init_data_dirs.py              # 📂 初始化
├── example.py                     # 📖 示例代码
├── ARCHITECTURE.md                # 🏛️ 本文档
└── PERFORMANCE_ANALYSIS.md        # 📊 性能分析
```

---

## 🔗 数据流转

### 记忆流转

```
对话输入
    ↓
工作记忆 (临时)
    ↓
重要性评估
    ↓
┌─────┴─────┐
↓           ↓
情景记忆    语义记忆
(事件)      (知识)
    ↓           ↓
SQLite + Markdown
```

### 知识流转

```
文档上传
    ↓
文档处理 (分块)
    ↓
向量化 (可选)
    ↓
构建索引
    ↓
用户查询
    ↓
相似度检索
    ↓
返回结果
```

### 好感度流转

```
对话内容
    ↓
情感分析
    ↓
计算分数变化
    ↓
更新数据库
    ↓
检查等级变化
    ↓
触发事件 (如解锁秘密)
```

---

## 🚀 性能考虑

### 响应时间分解

```
总响应时间: 2-4秒
├── 记忆检索: 0.2-0.5秒
├── RAG检索: 0.2-1.0秒
├── 上下文构建: 0.1-0.3秒
├── LLM推理: 1-3秒 (最大耗时)
├── 好感度计算: 0.05秒
└── 数据存储: 0.1-0.2秒
```

### 优化策略

1. **缓存**: 缓存检索结果
2. **并行**: 并行执行记忆和RAG检索
3. **裁剪**: 智能裁剪上下文
4. **异步**: 异步保存数据
5. **索引**: 优化数据库索引

详见: [17-性能优化指南](./17-PERFORMANCE.md)

---

## 🎓 学习路径

### 新手路径 (1小时)
1. [快速入门](./01-QUICKSTART.md)
2. [创建NPC](./11-CREATE_NPC.md)
3. 开始使用

### 理解路径 (3小时)
1. 完成新手路径
2. [记忆系统](./05-MEMORY_SYSTEM.md)
3. [RAG系统](./06-RAG_SYSTEM.md)
4. [上下文构建](./07-CONTEXT_BUILDER.md)

### 开发路径 (1天)
1. 完成理解路径
2. [API使用](./13-API_USAGE.md)
3. [扩展开发](./18-EXTENSION.md)
4. 阅读源码

---

## 🔗 相关文档

- [📖 完整文档列表](./README.md)
- [🚀 快速入门](./01-QUICKSTART.md)
- [📊 性能分析](../PERFORMANCE_ANALYSIS.md)
- [✅ 开发计划](../TODO.md)

---

恭喜！你现在已经理解了系统的整体架构！🎉

下一步，深入学习各个模块的详细文档。
